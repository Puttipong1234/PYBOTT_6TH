from flask import Flask, request, abort

from linebot import (
    LineBotApi, WebhookHandler
)
from linebot.exceptions import (
    InvalidSignatureError
)
from linebot.models import *
from FlexMessage.QuestionMsg import *
from FlexMessage.ResultMsg import *

from BasicFunction.COVID_ANALYZER import analyze_covid_from_user
from firebase import firebase
from BasicFunction.Firebase_Connect import get , get_daily_tracking , post, post_daily_tracking , update_daily_tracking , update , delete
from config import Firebase_DB_url
# Firebase_DB_url = "https://pybott-6th.firebaseio.com/" # Your firebase Application
firebase = firebase.FirebaseApplication(Firebase_DB_url, None)
DB_COV_TRACKER = "COV_TRACKER"
DB_USER_SESSION = "USER_SESSION"
DB_USER_DATA = "USER_DATA"

from config import Channel_access_token , Channel_secret

app = Flask(__name__)

line_bot_api = LineBotApi(Channel_access_token)
handler = WebhookHandler(Channel_secret)


@app.route("/callback", methods=['POST'])
def callback():
    # get X-Line-Signature header value
    signature = request.headers['X-Line-Signature']

    # get request body as text
    body = request.get_data(as_text=True)
    app.logger.info("Request body: " + body)

    # handle webhook body
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        print("Invalid signature. Please check your channel access token/channel secret.")
        abort(400)

    return 'OK'


@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    # INPUT AND PARSING DATA
    REPLY_TOKEN = event.reply_token 
    MESSAGE_FROM_USER = event.message.text
    UID = event.source.user_id
    
    # get user id
    profile = line_bot_api.get_profile(UID)
    DISPLAY_NAME = profile.display_name
    PROFILE_PIC = profile.picture_url
    
    #check user in system?
    user = get(uid=UID,firebase_app=firebase , database_name=DB_USER_DATA)
    if not user:
        # continue
        data = {"session" : "None"}
        post(uid=UID,data=data,firebase_app=firebase,database_name=DB_USER_SESSION)
        
        data = { "DISPLAY_NAME" : DISPLAY_NAME , "PROFILE_PIC" : PROFILE_PIC }
        post(uid=UID,data=data,firebase_app=firebase,database_name=DB_USER_DATA)
    
    
    user_session = get(uid=UID,firebase_app=firebase , database_name=DB_USER_SESSION)
    user_session = user_session["session"]
    if user_session == "None":
        if MESSAGE_FROM_USER == "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡πà‡∏ß‡∏¢":
            daily_report = {
            "‡∏°‡∏µ‡πÑ‡∏Ç‡πâ" : "",
            "‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏≠" : "",
            "‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏Ñ‡∏≠" : "",
            "‡∏ô‡πâ‡∏≥‡∏°‡∏π‡∏Å‡πÑ‡∏´‡∏•" : "",
            "‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏´‡∏≠‡∏ö" : "",
            "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" : "",
            "score" : 0,
            "‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞" : "",
            "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ‡∏ó‡∏µ‡πà‡∏û‡∏ö": ""
            }
            
            # create user daily report
            post_daily_tracking(uid=UID , data=daily_report , firebase_app=firebase , database_name=DB_COV_TRACKER)
            # update session
            
            session_data = {"session" : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏Ç‡πâ"}
            update(uid=UID,new_data=session_data,firebase_app=firebase,database_name=DB_USER_SESSION)
            
            #Reponse ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó
            Bubble = Base.get_or_new_from_json_dict(‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏Ç‡πâ(),FlexSendMessage)
            line_bot_api.reply_message(REPLY_TOKEN,messages=Bubble)
            
    
    ### func ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
    else:
        if  user_session == "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏Ç‡πâ": # validate session
                # "3" != 3
            if MESSAGE_FROM_USER in ["1","2","3","4","5"]: # validate input
                data = {"‡∏°‡∏µ‡πÑ‡∏Ç‡πâ" : MESSAGE_FROM_USER}
                update_daily_tracking(uid=UID,new_data=data,firebase_app=firebase,database_name=DB_COV_TRACKER) # update
                
                session_data = {"session" : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏≠"}
                update(uid=UID,new_data=session_data,firebase_app=firebase,database_name=DB_USER_SESSION) # update
                
                #Reponse ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó
                Bubble = Base.get_or_new_from_json_dict(‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏≠,FlexSendMessage)
                line_bot_api.reply_message(REPLY_TOKEN,messages=Bubble)
                
            else :
                line_bot_api.reply_message(REPLY_TOKEN,TextSendMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏∞ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç 1-5)"))
        
        elif  user_session == "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏≠":
            if MESSAGE_FROM_USER in ["1","2","3","4","5"]: # validate input
                data = {"‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏≠" : MESSAGE_FROM_USER}
                update_daily_tracking(uid=UID,new_data=data,firebase_app=firebase,database_name=DB_COV_TRACKER) # update
                
                session_data = {"session" : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏Ñ‡∏≠"}
                update(uid=UID,new_data=session_data,firebase_app=firebase,database_name=DB_USER_SESSION) # update
                
                #Reponse ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó
                Bubble = Base.get_or_new_from_json_dict(‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏Ñ‡∏≠,FlexSendMessage)
                line_bot_api.reply_message(REPLY_TOKEN,Bubble)
            else :
                line_bot_api.reply_message(REPLY_TOKEN,TextSendMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏∞ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç 1-5)"))
        
        elif  user_session == "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏Ñ‡∏≠":
            if MESSAGE_FROM_USER in ["1","2","3","4","5"]: # validate input
                data = {"‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πá‡∏ö‡∏Ñ‡∏≠" : MESSAGE_FROM_USER}
                update_daily_tracking(uid=UID,new_data=data,firebase_app=firebase,database_name=DB_COV_TRACKER) # update
                
                session_data = {"session" : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏°‡∏π‡∏Å‡πÑ‡∏´‡∏•"}
                update(uid=UID,new_data=session_data,firebase_app=firebase,database_name=DB_USER_SESSION) # update
                
                #Reponse ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó
                Bubble = Base.get_or_new_from_json_dict(‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏°‡∏π‡∏Å‡πÑ‡∏´‡∏•,FlexSendMessage)
                line_bot_api.reply_message(REPLY_TOKEN,Bubble)
            else :
                line_bot_api.reply_message(REPLY_TOKEN,TextSendMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏∞ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç 1-5)"))

        elif  user_session == "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏°‡∏π‡∏Å‡πÑ‡∏´‡∏•":
            if MESSAGE_FROM_USER in ["1","2","3","4","5"]: # validate input
                data = {"‡∏ô‡πâ‡∏≥‡∏°‡∏π‡∏Å‡πÑ‡∏´‡∏•" : MESSAGE_FROM_USER}
                update_daily_tracking(uid=UID,new_data=data,firebase_app=firebase,database_name=DB_COV_TRACKER) # update
                
                session_data = {"session" : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏´‡∏≠‡∏ö"}
                update(uid=UID,new_data=session_data,firebase_app=firebase,database_name=DB_USER_SESSION) # update
                
                #Reponse ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó
                Bubble = Base.get_or_new_from_json_dict(‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏´‡∏≠‡∏ö,FlexSendMessage)
                line_bot_api.reply_message(REPLY_TOKEN,Bubble)
            else :
                line_bot_api.reply_message(REPLY_TOKEN,TextSendMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏∞ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç 1-5)"))

        elif  user_session == "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏´‡∏≠‡∏ö":
            if MESSAGE_FROM_USER in ["1","2","3","4","5"]: # validate input
                data = {"‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏´‡∏≠‡∏ö" : MESSAGE_FROM_USER}
                
                update_daily_tracking(uid=UID,new_data=data,firebase_app=firebase,database_name=DB_COV_TRACKER) # update
                
                session_data = {"session" : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ"}
                update(uid=UID,new_data=session_data,firebase_app=firebase,database_name=DB_USER_SESSION) # update
                
                user_daily_data = get_daily_tracking(uid=UID,firebase_app=firebase,database_name=DB_COV_TRACKER)
                result = analyze_covid_from_user(UID,user_daily_data)
                
                post_daily_tracking(uid=UID,data=result,firebase_app=firebase,database_name=DB_COV_TRACKER)
                
                qbtn = QuickReplyButton(image_url="https://www.krungsri.com/bank/getmedia/1f37428a-a9e9-4860-9efd-90aeb886d3d5/krungsri-coronavirus-insurance-detail.jpg.aspx?resizemode=1",
                                        action=MessageAction(label="‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏£‡πâ‡∏≤",text="‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏£‡πâ‡∏≤"))
                
                qrep = QuickReply(items=[qbtn])
                
                line_bot_api.reply_message(REPLY_TOKEN,TextSendMessage("‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏∞üß°üß° \n ‡∏ó‡πà‡∏≤‡∏ô‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏µ‡∏Å‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞ \n üí™üí™ ‡∏ö‡∏≠‡∏Å‡∏ô‡πâ‡∏≠‡∏á‡∏´‡∏°‡∏≠‡πÑ‡∏î‡πâ‡∏ô‡∏∞",quick_reply=qrep)) # reponse
            
            else :
                line_bot_api.reply_message(REPLY_TOKEN,TextSendMessage("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏∞ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç 1-5)"))

        elif  user_session == "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ":
                data = {"‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ‡∏ó‡∏µ‡πà‡∏û‡∏ö" : MESSAGE_FROM_USER}
                
                update_daily_tracking(uid=UID,new_data=data,firebase_app=firebase,database_name=DB_COV_TRACKER) # update
                
                session_data = {"session" : "None"}
                update(uid=UID,new_data=session_data,firebase_app=firebase,database_name=DB_USER_SESSION) # update
                
                user_daily_data = get_daily_tracking(uid=UID,firebase_app=firebase,database_name=DB_COV_TRACKER)
                result = analyze_covid_from_user(UID,user_daily_data)
                
                post_daily_tracking(uid=UID,data=result,firebase_app=firebase,database_name=DB_COV_TRACKER)
                
                raw_Bubble = GenerateResultMsg(Profile_name=DISPLAY_NAME , UserId=UID , Dict_daily_data=result)
                Bubble = Base.get_or_new_from_json_dict(raw_Bubble,FlexSendMessage)
                line_bot_api.reply_message(REPLY_TOKEN,Bubble)


@handler.add(FollowEvent)
def handler_Follow(event):
    UID = event.source.user_id
    REPLY_TOKEN = event.reply_token
    line_bot_api.link_rich_menu_to_user(user_id=UID , rich_menu_id="richmenu-58d183f8dde81277a8f1d554c1ebacfb")

    #‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    image_message = ImageSendMessage(
    original_content_url='https://www.krungsri.com/bank/getmedia/1f37428a-a9e9-4860-9efd-90aeb886d3d5/krungsri-coronavirus-insurance-detail.jpg.aspx?resizemode=1',
    preview_image_url='https://www.krungsri.com/bank/getmedia/1f37428a-a9e9-4860-9efd-90aeb886d3d5/krungsri-coronavirus-insurance-detail.jpg.aspx?resizemode=1'
)
    
    qbtn1 = QuickReplyButton(image_url="https://www.krungsri.com/bank/getmedia/1f37428a-a9e9-4860-9efd-90aeb886d3d5/krungsri-coronavirus-insurance-detail.jpg.aspx?resizemode=1",
                            action=MessageAction(label="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡πà‡∏ß‡∏¢",text="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡πà‡∏ß‡∏¢"))
    
    qbtn2 = QuickReplyButton(image_url="https://www.krungsri.com/bank/getmedia/1f37428a-a9e9-4860-9efd-90aeb886d3d5/krungsri-coronavirus-insurance-detail.jpg.aspx?resizemode=1",
                            action=MessageAction(label="‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏á‡∏ö‡πâ‡∏≤‡∏á",text="‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏á‡∏ö‡πâ‡∏≤‡∏á"))
    
    qrep = QuickReply(items=[qbtn1,qbtn2])
    text_message = TextSendMessage(text="‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏Å‡∏±‡∏Å‡∏ï‡∏±‡∏ß" ,quick_reply=qrep)
    
    line_bot_api.reply_message(REPLY_TOKEN,messages=[image_message,text_message])


if __name__ == "__main__":
    app.run(port=80,debug=True)